# Web 性能

> 从工程的角度来讲，过度优化有时会造成很高昂的代价. 所以，一个好的工程师，不仅仅知道该怎么优化，更重要的是知道这里该不该优化。——摘自《[切图崽的自我修养－提高项目加载速度](https://segmentfault.com/a/1190000005873431)》

## 响应时间（latency ）与吞吐量（Thoughput）关系

![](../img/BenchmarkOptimalRate.png)

说明，建议采用中位数（Mean）评估系统的响应时间（latency）。

## 性能评估：

1.  定义一个系统的响应时间 latency ，建议是 TP99，以及成功率。汤森路透的定义：99.9%的响应时间必需在1ms之内，平均响应时间在1ms以内，100%的请求成功。

2.  在这个响应时间的限制下，找到最高吞吐量。测试用的数据，需要有大中小各种尺寸的数据，并可以混合。最好使用生产线上的测试数据。

3.  在这个吞吐量做 Soak Test 。使用第二步测试得到的吞吐量连续7天的不间断的压测系统。然后收集CPU，内存，硬盘/网络IO，等指标，查看系统是否稳定，如 CPU 平稳、内存使用平稳。那么，这个值就是系统的性能。

4.  找到系统的极限值。比如：在成功率 100% 情况下（不考虑响应时间长短），系统能坚持10分钟的吞吐量。

5.  做 Burst Test 。用第二步得到的吞吐量执行5分钟，然后在第四步得到的极限值执行1分钟，再回到第二步的吞吐量执行5钟，再到第四步的权限值执行1分钟，如此往复个一段时间，比如2天。收集系统数据：CPU、内存、硬盘/网络IO等，观察他们的曲线，以及相应的响应时间，确保系统是稳定的。

6.  低吞吐量和网络小包的测试。有时候，在低吞吐量的时候，可能会导致latency上升，比如TCP_NODELAY的参数没有开启会导致latency上升（详见TCP的那些事），而网络小包会导致带宽用不满也会导致性能上不去，所以，性能测试还需要根据实际情况有选择的测试一下这两咱场景。


（注：汤森路透会用第二步得到的吞吐量乘以66.7%来做为系统的软报警线，80%做为系统的硬报警线，而极限值仅仅用来扛突发的peak）

## 措施

1. 首屏所需要的 JS 与 CSS ，编译内联至 HTML 中
2. 对引入的资源排定优先次序
3. 应用JS缓存来存储。写入 local 的时候，同时在 Cookie 中种下当前所有要缓存内容的版本( MD5 戳)就行。 因为 cookie 是会在同步访问的时候，传送到服务端的，而 local 不会，所以，我们在服务端决定要传送内容，还是传送读取 local 代码。就靠我们种下的 cookie 了

4. DOM缓存（模板和数据）
5. 外链。将所有的JS/CSS等静态文件，通过一个接口全部返回。达到合并外链请求的目的，我们又将这静态文件，也一一缓存到localstorage中。每个文件以自己文件内容生成的版本号为戳，标识自己的唯一性。每次服务端返回页面时，会把当前在服务器上的所有静态文件版本号，返给前端。前端首屏加载完成后，会用这些版本号与local中进行一一对比，发现不一致的 JS/CSS ，会一起发送一个合并请求。这样可以保证每个文件的缓存与版本迭代。同时，也避免了过多的外链。
6. 使用 iconfont
7. 不在首屏的就要异步化按需加载
8. 少量静态文件的域名
9. 对于小于1k的图片，我们将其变为Base64编码，并融入到CSS中，一起缓存到localstorage中
10. AJAX接口最优调用
11. DNS 预解析（）
12. 减少HTTP重定向
13. 使用CDN（内容分发网络）
14. 传输压缩过的内容（Gzip压缩）
15. 去掉不必要的资源
16. 在客户端缓存资源
17. 无状态域名
18. 并行处理请求和响应
19. 拼合和连接
20. 服务端写相关信息到 header
21. 域名分区。页面中非常多请求都是一个域名下资源时，由于浏览器同时只能打开6个连接池，而且每个链接池是对不同域名起作用，所以很多请求一个域名会出现排队现象。如果把这些请求域名分区，让请求并行，从而加快资源下载。

## 参考

1. [性能测试应该怎么做？](http://coolshell.cn/articles/17381.html)
2. [京东前端：三级列表页持续架构优化](https://mp.weixin.qq.com/s?__biz=MzIwNjQwMzUwMQ==&mid=2247483922&idx=1&sn=0f887e42a4edaf05fa5ca73ea9c792b1)
3. [切图崽的自我修养－优化图片加载流程](https://segmentfault.com/a/1190000005904337)
4. [Dubbo 用户指南](http://dubbo.io/User+Guide-zh.htm)
5. [前端小站[聊一聊系列]](https://segmentfault.com/blog/frontenddriver)
6. [性能不好怎么办？对着清单撸一遍](http://mp.weixin.qq.com/s?__biz=MzAwNjY4NTQ4MA==&mid=2651174290&idx=1&sn=288518f030801f4d90878e806546487c)
7. [极快的node.js：来自领英（LinkedIn）移动的10个性能技巧](http://ourjs.com/detail/53410e63b189a25b71000001)
8. [为高负载网络优化 Nginx 和 Node.js](http://www.oschina.net/translate/optimising-nginx-node-js-and-networking-for-heavy-workloads)
